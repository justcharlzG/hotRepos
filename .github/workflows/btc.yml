name: Fetch BTC Price and Update README

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤© UTC 0:00 è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - master  # å¦‚æœæœ‰æ¨é€åˆ° master åˆ†æ”¯ï¼Œä¹Ÿä¼šè§¦å‘

permissions:
  contents: write  # å…è®¸ä¿®æ”¹å†…å®¹

jobs:
  fetch_and_update_btc_price:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: true 
          fetch-depth: 1  # åªæ‹‰å–æœ€æ–°çš„æäº¤

      # Step 2: Fetch BTC Price
      - name: Fetch BTC Price
        run: |
          # ä½¿ç”¨ CoinGecko API è·å– BTC å½“å‰ä»·æ ¼
          BTC_PRICE=$(curl -s https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd | jq -r '.bitcoin.usd')
          echo "BTC Price: $BTC_PRICE"
          echo "BTC_PRICE=$BTC_PRICE" >> $GITHUB_ENV

      # Step 3: Generate BTC Price Chart (using Python and Matplotlib)
      - name: Generate Price Chart
        run: |
          # å®‰è£… Python å’Œæ‰€éœ€çš„åº“
          sudo apt-get install python3-pip
          pip3 install matplotlib
          # è·å–å½“å‰æ—¶é—´å’Œ BTC ä»·æ ¼å¹¶ä¿å­˜
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "BTC Price at $CURRENT_TIME: $BTC_PRICE" >> btc_price_history.txt
          # ä½¿ç”¨ matplotlib ç”Ÿæˆ BTC ä»·æ ¼èµ°åŠ¿å›¾
          python3 - <<EOF
import matplotlib.pyplot as plt
import datetime

# ä»æ–‡ä»¶åŠ è½½ä»·æ ¼å†å²
time_stamps = []
prices = []
with open("btc_price_history.txt", "r") as f:
    lines = f.readlines()
    for line in lines:
        parts = line.split(":")
        if len(parts) == 2:
            time_stamps.append(parts[0].strip())
            prices.append(float(parts[1].strip()))

# ç»˜åˆ¶ä»·æ ¼èµ°åŠ¿å›¾
plt.figure(figsize=(10, 5))
plt.plot(time_stamps, prices, marker='o', color='b', label="BTC Price (USD)")
plt.xticks(rotation=45, ha="right")
plt.xlabel("Time")
plt.ylabel("Price (USD)")
plt.title("Bitcoin Price History")
plt.grid(True)
plt.tight_layout()

# ä¿å­˜å›¾è¡¨
plt.savefig("btc_price_chart.png")
EOF

      # Step 4: Update README with BTC Price Chart
      - name: Update README
        run: |
          # å°†ç”Ÿæˆçš„å›¾è¡¨æ·»åŠ åˆ°ä»“åº“ä¸­çš„ README æ–‡ä»¶
          echo "![BTC Price Chart](btc_price_chart.png)" >> README.md
          git add README.md
          git add btc_price_chart.png

      # Step 5: Setup Git Configuration
      - name: Setup Git Configuration
        run: |
          git config user.email "justcharlzg@outlook.com"
          git config user.name "justcharlzG"

      # Step 6: Commit and Push Changes to master
      - name: Commit and Push Changes
        run: |
          commit_messages=("Update BTC Price Chart: â°" "BTC Price Update: ğŸ’°" "Bitcoin Price Trend Update: ğŸ“Š")
          random_msg=${commit_messages[$RANDOM % ${#commit_messages[@]}]}

          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          else
            git commit -m "$random_msg"
            git push origin master
          fi
